<html>
   <head>

      <title>Feature Toggle Configurations Status</title>

      <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
      <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">



      <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.7.0.js"></script>
      <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
      <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
      <script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>


      <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js" data-auto-replace-svg="nest" data-observe-insertions="true"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

      <script>


                  var xValues = new Set();;
                  var yValues = [];
                  var barColors = ["green"]
                  var table;

                  $(document).ready(function() {

                        table = $('#table').DataTable( {
                                    select: true,
                                    "columnDefs": [
                                        { "width": "250px", "targets": 0 },
                                        { "width": "250px", "targets": 1 },
                                        { "width": "200px", "targets": 2 },
                                        { "width": "200px", "targets": 3 },
                                      ],
                                      pagingType: 'full_numbers'
                                } );

                   });

                  $.get("https://wmashal.github.io/test-jsons/ft3.json", function(data) {
                    //console.log(data);

                    const groupByToggleName = data["feature-toggles"].reduce((group, item) => {
                    const { name } = item;
                      group[name] = group[name] ?? [];
                      group[name].push(item);
                      return group;
                    }, {});


                    const groupByLandscape = data["feature-toggles"].reduce((group, item) => {
                    const { landscape } = item;
                      group[landscape] = group[landscape] ?? [];
                      group[landscape].push(item);
                      return group;
                    }, {});

                    const groupByLockState = data["feature-toggles"].reduce((group, item) => {
                    const { locked } = item;
                      group[locked] = group[locked] ?? [];
                      group[locked].push(item);
                      return group;
                    }, {});

                    //console.info(groupByLockState)


                    var count = 0;
                    $.each(groupByToggleName, function(key,value) {

                      var item = value[count++];
                      var row = document.createElement("tr");
                      var rowArr = [];

                      var nameCell = document.createElement("td");
                      nameCell.textContent = key;
                      rowArr.push($(nameCell).html())

                      var componentNameCell = document.createElement("td");
                      componentNameCell.textContent = item["componentName"];
                      rowArr.push($(componentNameCell).html())


                      var createdByCell = document.createElement("td");
                      createdByCell.textContent = item["createdBy"];
                      rowArr.push($(createdByCell).html())

                      var creationTimestamp = document.createElement("td");
                      creationTimestamp.textContent = item["creationTimestamp"];
                      rowArr.push($(creationTimestamp).html())


                      // Create cells for each landscape
                      var numberOfTogglesPerLandscape = 0;
                      $.each(value, function(key,togglevalue) {
                        //console.info(togglevalue["landscape"])
                        // landscapesTogglesCounterBarChart x axis
                        xValues.add(togglevalue["landscape"]);

                        var landscapeCell = document.createElement("td");
                        state = togglevalue["enabled"] === false ? $(landscapeCell).append('<i class="fa-solid fa-toggle-on" style="color: #bd0000;"></i>') : $(landscapeCell).append('<i class="fa-solid fa-toggle-on" style="color: #3b9c07;"></i>');

                        if(togglevalue["locked"] === "true"){
                            $(landscapeCell).append(' <i class="fa-solid fa-lock" style="color: #cc0000;"></i>')
                        }else{
                            $(landscapeCell).append(' <i class="fa-solid fa-unlock" style="color: #249b03;"></i>')
                        }

                        rowArr.push($(landscapeCell).html())
                      });

                      //console.log(rowArr)
                      table.row
                          .add(rowArr)
                          .draw(false);

                    });


                    var togglesStatusPerlandscapeCounterStackedBarChartData = [];


                    $.each(groupByLandscape, function(key,value) {
                      //console.info(key)
                      // landscapesTogglesCounterBarChart y axis
                      yValues.push(value.length)

                      // togglesStatusPerlandscapeCounterStackedBarChart data
                      var dataSetObject = new Object();
                      let landscapeEnabledToggles = value.filter(function(el){
                            return (el["enabled"] == true);
                      });


                      let landscapeDisabledToggles = value.filter(function(el){
                            return (el["enabled"] == false);
                      });

                      dataSetObject.x = key;
                      dataSetObject.enabled = landscapeEnabledToggles.length;
                      dataSetObject.disabled = landscapeDisabledToggles.length;
                      togglesStatusPerlandscapeCounterStackedBarChartData.push(dataSetObject)

                    });



                    //console.log(xValues);
                    //console.log(yValues);

                    const landscapesTogglesCounterBarChart = new Chart("landscapesTogglesCounterBarChart", {
                        type: "bar",
                        data: {
                          labels: Array.from(xValues),
                          datasets:[{
                            label:'Landscapes Toggles',
                            backgroundColor: [
                              'rgba(255, 99, 132, 0.2)',
                              'rgba(255, 159, 64, 0.2)',
                              'rgba(255, 205, 86, 0.2)',
                              'rgba(75, 192, 192, 0.2)',
                              'rgba(54, 162, 235, 0.2)',
                              'rgba(153, 102, 255, 0.2)',
                            ],
                            data: yValues,
                            borderWidth: 1
                          }]
                        },
                          options: {
                            //indexAxis: 'y',
                            plugins: {
                              title: {
                                display: true,
                                text: 'Toggles Count Per Landscape'
                              },
                            },
                            scale: {
                                ticks: {
                                  precision: 0
                                }
                              }
                          }
                      });



                      const doughnutdata = {
                          labels: [
                            'Locked',
                            'Unlocked',
                          ],
                          datasets: [{
                            label: 'Locked Toggles Count',
                            data: [groupByLockState[true].length,groupByLockState[false].length],
                            backgroundColor: [
                              'rgb(255, 99, 132)',
                              'rgb(34, 139, 34)',
                            ],
                            hoverOffset: 4
                          }]
                        };

                      const lockedCounterBarChart = new Chart("lockedCounterBarChart", {
                          type: "doughnut",
                          data: doughnutdata,
                            options: {
                              //indexAxis: 'y',
                              plugins: {
                                title: {
                                  display: true,
                                  text: 'Locked / Unlocked Toggles Count'
                                },
                              }
                            }
                        });


                        const stackedLabels = Object.keys(groupByLandscape);

                        const togglesStatusPerlandscapeCounterStackedBarChart = new Chart("togglesStatusPerlandscapeCounterStackedBarChart", {
                            type: "bar",
                            data: {
                              labels: stackedLabels,
                              datasets: [{
                                label: 'Enabled',
                                backgroundColor: ['rgb(34, 139, 34)'],
                                data: togglesStatusPerlandscapeCounterStackedBarChartData,
                                parsing: {
                                  yAxisKey: 'enabled'
                                }
                              }, {
                                label: 'Disabled',
                                backgroundColor: ['rgb(199, 0, 57)'],
                                data: togglesStatusPerlandscapeCounterStackedBarChartData,
                                parsing: {
                                  yAxisKey: 'disabled'
                                }
                              }]
                            },
                            options: {
                              plugins: {
                                title: {
                                  display: true,
                                  text: 'Toggles Status Per Landscape Counter'
                                },
                              },
                              //responsive: true,
                              scales: {
                                x: {
                                  stacked: true,
                                },
                                y: {
                                  stacked: true
                                }
                              }
                            }
                          });


                  });

      </script>
      <style>
        .mainContainer{
          display:flex;
          flex-direction: column;
          row-gap: 10px;
          margin: 20px;
          width:100%
        }

        .chartsContainer{
          display:flex;
          column-gap: 20px;
          height:350px;
          max-height:350px;
          margin: 40px;
        }

        .tableContainer{
          margin: 40px;
        }
      </style>
   </head>
   <body>
   <div class="mainContainer">
      <div class="chartsContainer">
        <canvas id="landscapesTogglesCounterBarChart"></canvas>
        <canvas id="lockedCounterBarChart"></canvas>
        <canvas id="togglesStatusPerlandscapeCounterStackedBarChart"></canvas>
      </div>
      <div class="tableContainer">
            <table id="table" class="table table-striped table-bordered">
            	<thead>
                  <th>Name</th>
                  <th>Component Name</th>
                  <th>Created By</th>
                  <th>Creation Date</th>
                  <th>Staging</th>
                  <th>Perf</th>
                  <th>Integrate</th>
                  <th>Canary</th>
                  <th>Hotfix</th>
                  <th>Live</th>
            	</thead>
            	<tbody>
            	</tbody>
            </table>
      </div>
    <div>
   </body>
</html>
