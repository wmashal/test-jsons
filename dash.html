<html>
   <head>

      <title>Feature Toggle Configurations Status</title>

      <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
      <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
      <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">


      <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.7.0.js"></script>
      <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
      <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
      <script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
      <script type="text/javascript" language="javascript" src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js" data-auto-replace-svg="nest" data-observe-insertions="true"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

      <script>


                  var xValues = new Set();;
                  var yValues = [];
                  var table;
                  var lowHighLandscapesDiffTable;
                  $(".lowHighLandscapesTableContainer").hide();
                  $( function() {
                    $(document).tooltip({
                         autoClose: false,
                         tooltipClass: "GFG",
                         position: {
                            my: "right top",
                            at: "right center"
                         }
                     });
                        table = $('#table').DataTable( {
                                    select: true,
                                    "columnDefs": [
                                        { "width": "250px", "targets": 0 },
                                        { "width": "250px", "targets": 1 },
                                        { "width": "200px", "targets": 2 },
                                        { "width": "200px", "targets": 3 },
                                      ],
                                      pagingType: 'full_numbers'

                                } );

                      lowHighLandscapesDiffTable = $('#lowHighLandscapesTable').DataTable( {
                                  "columnDefs": [
                                      { "width": "180px", "targets": 0 },
                                      { "width": "180px", "targets": 1 },
                                      { "width": "50px", "targets": 2 },
                                      { "width": "50px", "targets": 3 },
                                      { "width": "50px", "targets": 4 },
                                      { "width": "50px", "targets": 5 },
                                    ],
                                    paging: false,
                                    "bInfo": false,
                                    ordering: false,
                                    searching: false
                              } );

                   });

                  $.get("https://wmashal.github.io/test-jsons/ft3.json", function(data) {

                      let lowHighLandscapeDiff =  getLowHighLandscapesDiff(data);
                      buildLowHighLandscapesDiffTable(lowHighLandscapeDiff);

                    //console.log(data);
                    const groupByToggleName = data["feature-toggles"].reduce((group, item) => {
                    const { name } = item;
                      group[name] = group[name] ?? [];
                      group[name].push(item);
                      return group;
                    }, {});


                    const groupByLandscape = data["feature-toggles"].reduce((group, item) => {
                    const { landscape } = item;
                      group[landscape] = group[landscape] ?? [];
                      group[landscape].push(item);
                      return group;
                    }, {});

                    const groupByLockState = data["feature-toggles"].reduce((group, item) => {
                    const { locked } = item;
                      group[locked] = group[locked] ?? [];
                      group[locked].push(item);
                      return group;
                    }, {});

                    //console.info(groupByLockState)


                    var count = 0;
                    var landscapeTogglesDiffrences = new Map();
                    var liveHotfixDiffrentToggles = [];
                    var IntCanaryDiffrentToggles = [];

                    $.each(groupByToggleName, function(key,value) {

                      var item = value[count++];
                      //var row = document.createElement("tr");
                      var rowArr = [];

                      var nameCell = document.createElement("td");
                      nameCell.textContent = key;
                      rowArr.push($(nameCell).html())

                      var componentNameCell = document.createElement("td");
                      componentNameCell.textContent = item["componentName"];
                      rowArr.push($(componentNameCell).html())


                      var createdByCell = document.createElement("td");
                      createdByCell.textContent = item["createdBy"];
                      rowArr.push($(createdByCell).html())

                      var creationTimestamp = document.createElement("td");
                      formatedcreationTimestamp = moment(item["creationTimestamp"]).format("YYYY-MM-DD");
                      creationTimestamp.textContent = formatedcreationTimestamp;
                      rowArr.push($(creationTimestamp).html())

                      var dateModifiedTimestamp = document.createElement("td");
                      formateddateModifiedTimestamp = moment(item["modefiedTimestamp"]).format("YYYY-MM-DD");
                      dateModifiedTimestamp.textContent = formateddateModifiedTimestamp;
                      rowArr.push($(dateModifiedTimestamp).html())


                      // Create cells for each landscape
                      //var numberOfTogglesPerLandscape = 0;
                      $.each(value, function(key,togglevalue) {
                        //console.info(togglevalue["landscape"])
                        // landscapesTogglesCounterBarChart x axis
                        xValues.add(togglevalue["landscape"]);

                        const strObj=Object.entries(togglevalue["strategy"]).reduce( (str, entry,i) => `${str}${i>0?'&':''}${entry[1]}`, "")
                        let landscapeTooltip = "Additional Info: \n Name: "+togglevalue["name"] +" \n Landscape: "+togglevalue["landscape"] + " \n Version: "+togglevalue["version"] + " \n Created: "+togglevalue["creationTimestamp"] + " \n Strategies : "+strObj;
                        let landscapeCell = document.createElement("td");
                        togglevalue["enabled"] === false ? $(landscapeCell).append('<i class="fa-solid fa-toggle-on" style="color: #bd0000;"></i>') : $(landscapeCell).append('<i class="fa-solid fa-toggle-on" style="color: #3b9c07;"></i>');

                        if(togglevalue["locked"] === "true"){

                          let lockingDuration = "";
                          if(togglevalue["lastLockTimestamp"].length > 0){
                             lockingDuration = calculateTimeDifference(moment(togglevalue["lastLockTimestamp"]));
                          }
                          $(landscapeCell).append(' <i class="fa-solid fa-lock" style="color: #cc0000;" title="'+lockingDuration+'"></i>')

                        }

                        rowArr.push($(landscapeCell).html())
                        $(".fa-toggle-on").attr("title",landscapeTooltip)

                      });


                      //console.log(rowArr)
                      table.row
                          .add(rowArr)
                          .draw(true);

                    });


                  function getLowHighLandscapesDiff(data){

                    var diffTogglesArr = [];

                    const liveToggles = data['feature-toggles'].filter(toggle => toggle.landscape === 'live');
                    const hotfixToggles = data['feature-toggles'].filter(toggle => toggle.landscape === 'hotfix');

                    const intToggles = data['feature-toggles'].filter(toggle => toggle.landscape === 'Int');
                    const canaryToggles = data['feature-toggles'].filter(toggle => toggle.landscape === 'canary');

                    for (let liveToggle of liveToggles) {
                      const matchingHotfixToggle = hotfixToggles.find(toggle => toggle.name === liveToggle.name);
                      if (matchingHotfixToggle && !matchingHotfixToggle.enabled && liveToggle.enabled) {
                          diffTogglesArr.push(liveToggle);
                          diffTogglesArr.push(matchingHotfixToggle);
                      }
                    }

                    for (let canaryToggle of canaryToggles) {
                      const matchingIntToggle = intToggles.find(toggle => toggle.name === canaryToggle.name);
                      if (matchingIntToggle && !matchingIntToggle.enabled && canaryToggle.enabled) {
                          diffTogglesArr.push(canaryToggle);
                          diffTogglesArr.push(matchingIntToggle);
                      }
                    }

                    console.log(diffTogglesArr);

                    return diffTogglesArr;

                  }


                  function buildLowHighLandscapesDiffTable(lowHighLandscapeDiff){

                      if(lowHighLandscapeDiff){

                          $(".lowHighLandscapesTableContainer").show();
                          const groupByToggleName = lowHighLandscapeDiff.reduce((group, item) => {
                              const { name } = item;
                              group[name] = group[name] ?? [];
                              group[name].push(item);
                              return group;
                          }, {});

                          let count = 0;



                          let landscapesCount = 2;
                          $.each(groupByToggleName, function(key,value) {

                              let diffRow = createDiffRow();

                              let item = value[count++];
                              let diffNameCell = diffRow.children[0] //document.createElement("td");
                              diffNameCell.textContent = key;

                              let diffComponentNameCell = diffRow.children[1]//document.createElement("td");
                              diffComponentNameCell.textContent = item["componentName"];

                              $.each(value, function(key,togglevalue) {
                                  let landscapeCell = diffRow.children[landscapesCount++] //document.createElement("td");
                                  togglevalue["enabled"] === false ? $(landscapeCell).html('<i class="fa-solid fa-toggle-on" style="color: #bd0000;"></i>')
                                      : $(landscapeCell).html('<i class="fa-solid fa-toggle-on" style="color: #3b9c07;"></i>');

                              });

                              lowHighLandscapesDiffTable.row
                                  .add(diffRow)
                                  .draw(false);
                          });
                      }

                  }

                  function createDiffRow(){
                      let diffRow = document.createElement("tr");
                      let td = document.createElement("td");
                      td.textContent = 'NA';
                      let td1 = document.createElement("td");
                      td1.textContent = 'NA';
                      let td2 = document.createElement("td");
                      td2.textContent = 'NA';
                      let td3 = document.createElement("td");
                      td3.textContent = 'NA';
                      let td4 = document.createElement("td");
                      td4.textContent = 'NA';
                      let td5 = document.createElement("td");
                      td5.textContent = 'NA';
                      diffRow.append(td)
                      diffRow.append(td1)
                      diffRow.append(td2)
                      diffRow.append(td3)
                      diffRow.append(td4)
                      diffRow.append(td5)

                      return diffRow;
                  }

                      var togglesStatusPerlandscapeCounterStackedBarChartData = [];

                      $.each(groupByLandscape, function(key,value) {

                          //console.info(key)
                          // landscapesTogglesCounterBarChart y axis
                          yValues.push(value.length)

                          // togglesStatusPerlandscapeCounterStackedBarChart data
                          var dataSetObject = new Object();
                          let landscapeEnabledToggles = value.filter(function(el){
                              return (el["enabled"] == true);
                          });


                          let landscapeDisabledToggles = value.filter(function(el){
                              return (el["enabled"] == false);
                          });

                          dataSetObject.x = key;
                          dataSetObject.enabled = landscapeEnabledToggles.length;
                          dataSetObject.disabled = landscapeDisabledToggles.length;
                          togglesStatusPerlandscapeCounterStackedBarChartData.push(dataSetObject)

                      });


                      const doughnutdata = {
                          labels: [
                            'Locked',
                            'Unlocked',
                          ],
                          datasets: [{
                            label: 'Locked Toggles Count',
                            data: [groupByLockState[true].length,groupByLockState[false].length],
                            backgroundColor: [
                              'rgb(255, 99, 132)',
                              'rgb(34, 139, 34)',
                            ],
                            hoverOffset: 4
                          }]
                        };

                      const lockedCounterBarChart = new Chart("lockedCounterBarChart", {
                          type: "doughnut",
                          data: doughnutdata,
                            options: {
                              //indexAxis: 'y',
                              plugins: {
                                title: {
                                  display: true,
                                  text: 'Locked / Unlocked Toggles Count'
                                },
                              }
                            }
                        });


                        const stackedLabels = Object.keys(groupByLandscape);

                        const togglesStatusPerlandscapeCounterStackedBarChart = new Chart("togglesStatusPerlandscapeCounterStackedBarChart", {
                            type: "bar",
                            data: {
                              labels: stackedLabels,
                              datasets: [{
                                label: 'Enabled',
                                backgroundColor: ['rgb(34, 139, 34)'],
                                data: togglesStatusPerlandscapeCounterStackedBarChartData,
                                parsing: {
                                  yAxisKey: 'enabled'
                                }
                              }, {
                                label: 'Disabled',
                                backgroundColor: ['rgb(199, 0, 57)'],
                                data: togglesStatusPerlandscapeCounterStackedBarChartData,
                                parsing: {
                                  yAxisKey: 'disabled'
                                }
                              }]
                            },
                            options: {
                              plugins: {
                                title: {
                                  display: true,
                                  text: 'Toggles Status Per Landscape Counter'
                                },
                              },
                              //responsive: true,
                              scales: {
                                x: {
                                  stacked: true,
                                },
                                y: {
                                  stacked: true
                                }
                              }
                            }
                          });


                  });

                  function calculateTimeDifference(lockDate) {
                     var now = moment();
                     var duration = moment.duration(now.diff(lockDate));
                     var days = Math.floor(duration.asDays());
                     var hours = Math.floor(duration.asHours() % 24);

                     var timeDiff = "Locking duration is " + days + " days and " + hours + " hours";
                     return timeDiff;
                   }

      </script>
      <style>
        .mainContainer{
          display:flex;
          flex-direction: column;
          row-gap: 10px;
          margin: 20px;
          width:100%
        }

        .chartsContainer{
          display:flex;
          column-gap: 60px;
          height:350px;
          max-height:350px;
          margin: 40px;
        }

        .tableContainer{
          margin: 40px;
        }

        .GFG{
            color: black;
            background: #FFF700;
            padding: 5px 10px;
            white-space: pre-line;
        }

      </style>
   </head>
   <body>
   <div class="mainContainer">
      <div class="chartsContainer">
        <!-- <canvas id="landscapesTogglesCounterBarChart"></canvas> -->
          <div class="lowHighLandscapesTableContainer">
              <div class="alert alert-danger" role="alert">
                  Disparities in toggle states between low and high landscapes
              </div>
              <table id="lowHighLandscapesTable" class="table table-striped table-bordered">
                  <thead>
                    <th>Name</th>
                    <th>Component Name</th>
                    <th>Live</th>
                    <th>Hotfix</th>
                    <th>Canary</th>
                    <th>Integrate</th>
                  </thead>
                  <tbody>
                  </tbody>
              </table>
          </div>

        <canvas id="lockedCounterBarChart"></canvas>
        <canvas id="togglesStatusPerlandscapeCounterStackedBarChart"></canvas>
      </div>
      <div class="tableContainer">
            <table id="table" class="table table-striped table-bordered">
            	<thead>
                  <th>Name</th>
                  <th>Component Name</th>
                  <th>Created By</th>
                  <th>Creation Date</th>
                  <th>Date Modified</th>
                  <th>Staging</th>
                  <th>Perf</th>
                  <th>Integrate</th>
                  <th>Canary</th>
                  <th>Hotfix</th>
                  <th>Live</th>
            	</thead>
            	<tbody>
            	</tbody>
            </table>
      </div>
    <div>
   </body>
</html>
